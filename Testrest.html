<!DOCTYPE html>
<html>
  <head>
    <title>Restaurant Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a73e8">
    <style>
      :root {
        overflow: hidden !important;
        height: 100% !important;
        --primary: #1a73e8;
        --primary-dark: #0d5cb6;
        --surface: #f8f9fa;
        --border: #dadce0;
        --success: #34a853;
      }

      html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden !important;
        touch-action: manipulation;
        -webkit-overflow-scrolling: touch;
        -webkit-tap-highlight-color: transparent;
        overscroll-behavior: none;
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
      }

      #voiceflow-container {
        width: 100vw !important;
        height: 100vh !important;
        position: fixed;
        top: 0;
        left: 0;
      }

      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .start-instruction {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 1.5em;
        color: #2c3e50;
        text-align: center;
        cursor: pointer;
        z-index: 10000;
        animation: pulse 2s infinite;
        padding: 20px;
      }

      .start-instruction img {
        width: 120px;
        height: 120px;
        margin-bottom: 30px;
      }

      .start-instruction h1 {
        font-size: 2.2rem;
        margin-bottom: 20px;
        color: var(--primary);
      }

      .start-instruction p {
        font-size: 1.2rem;
        max-width: 500px;
        line-height: 1.6;
        margin-bottom: 20px;
      }

      .table-number {
        position: fixed;
        top: 15px;
        right: 15px;
        background: var(--primary);
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        z-index: 10001;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .focus-hint {
        position: fixed;
        bottom: 20px;
        left: 0;
        width: 100%;
        text-align: center;
        color: #5f6368;
        font-size: 0.9rem;
        z-index: 10002;
        padding: 10px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(5px);
        animation: fadeIn 1.5s;
        display: none;
      }

      @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.02); opacity: 0.9; }
        100% { transform: scale(1); opacity: 1; }
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
    </style>
  </head>
  <body>
    <div class="start-instruction">
      <svg width="120" height="120" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 3H4C2.9 3 2 3.9 2 5V19C2 20.1 2.9 21 4 21H20C21.1 21 22 20.1 22 19V5C22 3.9 21.1 3 20 3ZM20 19H4V5H20V19Z" fill="#1a73e8"/>
        <path d="M21 6H3C2.45 6 2 6.45 2 7V8H22V7C22 6.45 21.55 6 21 6Z" fill="#1a73e8"/>
        <path d="M11 10H6V14H11V10Z" fill="#1a73e8"/>
        <path d="M18 10H13V12H18V10Z" fill="#1a73e8"/>
        <path d="M18 13H13V15H18V13Z" fill="#1a73e8"/>
      </svg>
      <h1>Welcome to Gourmet Bistro</h1>
      <p>Tap anywhere to start ordering with our digital assistant. We'll help you choose delicious dishes and place your order.</p>
      <div style="font-size: 1.3rem; margin-top: 10px;">üçî üçï ü•ó üç∞</div>
    </div>
    <div id="loading">
      <div class="spinner"></div>
    </div>
    <div id="voiceflow-container"></div>
    <div class="focus-hint" id="focusHint">Tip: Tap here to type your message</div>

    <script type="text/javascript">
      let chatInitialized = false;
      const synth = window.speechSynthesis;
      const urlParams = new URLSearchParams(window.location.search);
      const tableNumber = urlParams.get('table');
      let focusInterval;

      // Validate table number
      if (!tableNumber || isNaN(tableNumber)) {
        document.querySelector('.start-instruction').innerHTML = 
          '<h1>‚ö†Ô∏è Invalid Table QR Code</h1>' + 
          '<p>Please scan the QR code on your table to start ordering.</p>' +
          '<div style="margin-top:20px;font-size:1rem;color:#e74c3c;">If you continue to have issues, please ask your server for assistance.</div>';
      }

      function updateViewportHeight() {
        document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
      }

      function initializeChat() {
        if (chatInitialized) return;
        chatInitialized = true;
        
        document.querySelector('.start-instruction').style.display = 'none';
        
        // Show table number
        const tableDisplay = document.createElement('div');
        tableDisplay.className = 'table-number';
        tableDisplay.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M4 22H20C21.1 22 22 21.1 22 20V4C22 2.9 21.1 2 20 2H4C2.9 2 2 2.9 2 4V20C2 21.1 2.9 22 4 22ZM4 4H20V20H4V4Z"/><path d="M8 6H6V8H8V6Z"/><path d="M18 6H10V8H18V6Z"/><path d="M8 10H6V12H8V10Z"/><path d="M18 10H10V12H18V10Z"/><path d="M8 14H6V16H8V14Z"/><path d="M18 14H10V16H18V14Z"/><path d="M8 18H6V20H8V18Z"/><path d="M18 18H10V20H18V18Z"/></svg> Table ${tableNumber}`;
        document.body.appendChild(tableDisplay);

        const loading = document.getElementById('loading');
        loading.style.display = 'flex';
        setTimeout(() => loading.style.opacity = '1', 10);

        const script = document.createElement('script');
        script.src = 'https://cdn.voiceflow.com/widget-next/bundle.mjs';
        
        script.onload = () => {
          window.voiceflow.chat.load({
            verify: { projectID: '6832111f0307aee0c811367c' },
            url: 'https://general-runtime.voiceflow.com',
            versionID: 'production',
            session: { 
              user: {
                variables: { 
                  tableNumber: parseInt(tableNumber) 
                }
              }
            },
            render: {
              mode: 'embedded',
              target: document.body,
              launcher: 'none'
            }
          }).then(() => {
            window.voiceflow.chat.open();
            
            // Auto-focus input
            setTimeout(() => {
              const input = document.querySelector('input[type="text"]');
              if (input) {
                input.focus();
              }
            }, 500);

            // Handle bot messages
            const observer = new MutationObserver(mutations => {
              mutations.forEach(({ addedNodes }) => {
                addedNodes.forEach(node => {
                  if (node.classList?.contains('vfrc-message--bot')) {
                    const text = node.querySelector('.vfrc-message-content')?.textContent;
                    if (text) {
                      const utterance = new SpeechSynthesisUtterance(text);
                      utterance.rate = 1.1;
                      synth.speak(utterance);
                      
                      // After bot speaks, focus input
                      setTimeout(() => {
                        const input = document.querySelector('input[type="text"]');
                        if (input) {
                          input.focus();
                        }
                      }, 300);
                    }
                  }
                });
              });
            });

            observer.observe(document.body, {
              childList: true,
              subtree: true
            });

            // FIX: Maintain input focus after interactions
            focusInterval = setInterval(() => {
              const input = document.querySelector('input[type="text"]');
              const chatInput = document.querySelector('.vfrc-chat-input');
              
              if (input && !input.disabled) {
                // Show hint if input is not focused
                const focusHint = document.getElementById('focusHint');
                if (document.activeElement !== input && !input.disabled) {
                  focusHint.style.display = 'block';
                } else {
                  focusHint.style.display = 'none';
                }
                
                // Focus input if it's not disabled and not already focused
                if (document.activeElement !== input && !input.disabled) {
                  input.focus();
                }
              }
              
              if (chatInput) {
                chatInput.addEventListener('click', () => {
                  const input = document.querySelector('input[type="text"]');
                  if (input) {
                    input.focus();
                  }
                });
              }
            }, 300);

            loading.style.opacity = '0';
            setTimeout(() => loading.style.display = 'none', 300);
          });
        };

        script.onerror = () => {
          loading.innerHTML = 'Failed to load chat. Please check connection.';
        };

        document.body.appendChild(script);
      }

      document.addEventListener('DOMContentLoaded', function() {
        updateViewportHeight();
        window.addEventListener('resize', updateViewportHeight);
        
        document.body.addEventListener('click', () => {
          if (!chatInitialized && tableNumber) {
            initializeChat();
          }
        }, { once: true });
      });
      
      // Clean up when leaving
      window.addEventListener('beforeunload', () => {
        if (focusInterval) clearInterval(focusInterval);
      });
    </script>
  </body>
</html>
