<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ff8c00">
    <title>CrunchCraft - Restaurant Ordering</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Existing styles remain unchanged */
        
        /* New loading animation styles */
        .vf-loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background: transparent !important;
            min-height: 80px;
        }
        
        .text-container {
            position: relative;
            height: 24px;
            width: 160px;
            text-align: center;
        }
        
        .loading-text {
            position: absolute;
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 0.5px;
            opacity: 0;
            animation: textFade 6s infinite;
            text-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
        }
        
        .text-1 { animation-delay: 0s; }
        .text-2 { animation-delay: 3s; }
        
        @keyframes textFade {
            0% { opacity: 0; transform: translateY(5px); }
            20% { opacity: 1; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(0); }
            70% { opacity: 0; transform: translateY(-5px); }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Initial Loading Screen (remains unchanged) -->
    <div id="initial-loading">
        <!-- Content unchanged -->
    </div>
    
    <!-- Loading Spinner for Voiceflow -->
    <div id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- Voiceflow Container -->
    <div id="voiceflow-container"></div>
    
    <script type="text/javascript">
        // Enhanced Loading Animation Extension
        const LoadingAnimation = {
            name: 'LoadingAnimation',
            type: 'response',
            match: ({ trace }) => 
                trace.type === 'loading_screen' || (trace.payload && trace.payload.name === 'loading_screen'),
            render: ({ element }) => {
                // Create container
                const container = document.createElement('div');
                container.classList.add('vf-loading-container');
                container.id = 'vf-custom-loading-animation';
                
                // Create the animation HTML
                container.innerHTML = `
                    <div class="text-container">
                        <div class="loading-text text-1">Just a moment</div>
                        <div class="loading-text text-2">Almost there</div>
                    </div>
                `;

                // Add to the element
                element.appendChild(container);
                
                // Auto-removal when AI responds
                const observer = new MutationObserver(() => {
                    const aiMessages = document.querySelectorAll('.vfrc-message--bot');
                    if (aiMessages.length > 0) {
                        // Start fade out animation
                        container.style.opacity = '0';
                        container.style.transition = 'opacity 0.5s ease';
                        
                        // Remove after animation completes
                        setTimeout(() => {
                            if (container.parentNode) {
                                container.parentNode.removeChild(container);
                            }
                            observer.disconnect();
                        }, 500);
                    }
                });
                
                // Start observing the chat container
                const chatContainer = document.querySelector('.vfrc-chat');
                if (chatContainer) {
                    observer.observe(chatContainer, { 
                        childList: true, 
                        subtree: true 
                    });
                }
                
                // Fallback removal after 10 seconds
                setTimeout(() => {
                    if (container.parentNode) {
                        container.parentNode.removeChild(container);
                        observer.disconnect();
                    }
                }, 10000);
            }
        };

        // Chat initialization variables
        let chatInitialized = false;
        const synth = window.speechSynthesis;
        const urlParams = new URLSearchParams(window.location.search);
        const tableNumber = urlParams.get('table');
        let countdown = 3;

        // Update viewport height for mobile devices
        function updateViewportHeight() {
            document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
        }

        // Initialize the chat
        function initializeChat() {
            if (chatInitialized) return;
            chatInitialized = true;
            
            // Hide initial loading screen
            document.getElementById('initial-loading').style.display = 'none';
            
            // Show loading spinner
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            setTimeout(() => loading.style.opacity = '1', 10);

            // Load Voiceflow script
            const script = document.createElement('script');
            script.src = 'https://cdn.voiceflow.com/widget-next/bundle.mjs';
            
            script.onload = () => {
                window.voiceflow.chat.load({
                    verify: { projectID: '6849cc61894655c0d602c27d' },
                    url: 'https://general-runtime.voiceflow.com',
                    versionID: 'production',
                    assistant: {
                        extensions: [LoadingAnimation]
                    },
                    // Pass table number to Voiceflow
                    launch: {
                        event: {
                            type: 'launch',
                            payload: {
                                tableNumber: parseInt(tableNumber) || 0
                            }
                        }
                    },
                    render: {
                        mode: 'embedded',
                        target: document.getElementById('voiceflow-container'),
                        launcher: 'none'
                    }
                }).then(() => {
                    // Show the chat container
                    document.getElementById('voiceflow-container').classList.add('active');
                    
                    // Auto-focus input
                    setTimeout(() => {
                        document.querySelector('input[type="text"]')?.focus();
                    }, 500);

                    // Handle bot messages with text-to-speech
                    const observer = new MutationObserver(mutations => {
                        mutations.forEach(({ addedNodes }) => {
                            addedNodes.forEach(node => {
                                if (node.classList?.contains('vfrc-message--bot')) {
                                    const text = node.querySelector('.vfrc-message-content')?.textContent;
                                    if (text) {
                                        const utterance = new SpeechSynthesisUtterance(text);
                                        utterance.rate = 1.1;
                                        synth.speak(utterance);
                                    }
                                }
                            });
                        });
                    });

                    observer.observe(document.body, {
                        childList: true,
                        subtree: true
                    });

                    // Hide loading spinner
                    loading.style.opacity = '0';
                    setTimeout(() => loading.style.display = 'none', 300);
                });
            };

            script.onerror = () => {
                loading.innerHTML = 'Failed to load chat. Please check connection.';
            };

            document.body.appendChild(script);
        }

        // Start countdown and progress animation
        function startCountdown() {
            const progressBar = document.getElementById('progress-bar');
            const countdownElement = document.getElementById('countdown');
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 100 / (countdown * 10);
                progressBar.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    initializeChat();
                }
            }, 100);
            
            // Update countdown text
            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown <= 0) {
                    countdownElement.textContent = "Starting now...";
                    clearInterval(countdownInterval);
                } else {
                    countdownElement.textContent = `Starting in ${countdown} second${countdown !== 1 ? 's' : ''}...`;
                }
            }, 1000);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            updateViewportHeight();
            window.addEventListener('resize', updateViewportHeight);
            
            // Validate table number
            const initialLoading = document.getElementById('initial-loading');
            
            if (!tableNumber || isNaN(tableNumber)) {
                initialLoading.innerHTML = `
                    <div class="logo-container">
                        <div class="logo">CRUNCH<span>CRAFT</span></div>
                    </div>
                    <div style="text-align: center; color: white; max-width: 80%;">
                        <h2 style="margin-bottom: 20px;">⚠️ Invalid QR Code</h2>
                        <p>Please scan the QR code on your table to start ordering.</p>
                        <p style="margin-top: 30px; font-size: 0.9rem;">If you believe this is an error, please ask a staff member for assistance.</p>
                    </div>
                `;
            } else {
                // Start countdown to initialize chat
                setTimeout(startCountdown, 500);
            }
        });
    </script>
</body>
</html>
