<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ff8c00">
    <title>CrunchCraft - Restaurant Ordering</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ... (your existing styles remain unchanged) ... */
        
        /* Add new styles for location message */
        .location-message {
            font-size: clamp(1rem, 4vw, 1.2rem);
            color: white;
            margin: 15px 0;
            text-align: center;
            max-width: 90%;
            font-weight: 500;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .location-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            animation: pulse 1.5s infinite;
        }
        
        .retry-button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: bold;
            margin-top: 15px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: var(--transition);
        }
        
        .retry-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- New Initial Loading Screen -->
    <div id="initial-loading">
        <div class="logo-container">
            <div class="logo">CRUNCH<span>CRAFT</span></div>
            <div class="tagline">Gourmet Burgers & More</div>
        </div>
        
        <div class="burger-assembly">
            <div class="burger-layer bun-top"></div>
            <div class="burger-layer lettuce"></div>
            <div class="burger-layer cheese"></div>
            <div class="burger-layer patty"></div>
            <div class="burger-layer bun-bottom"></div>
        </div>
        
        <div class="loading-message">
            Preparing your ordering experience...
        </div>
        
        <!-- Location verification message -->
        <div class="location-message" id="location-message">
            <div class="location-icon">üìç</div>
            Verifying your location...
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div class="countdown" id="countdown">Starting in 3 seconds...</div>
    </div>
    
    <!-- Loading Spinner for Voiceflow -->
    <div id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- Voiceflow Container -->
    <div id="voiceflow-container"></div>
    
    <!-- Voiceflow script with external extensions -->
    <script type="module">
      // Import the required extensions
      import { LoadingAnimationExtension } from 'https://chhotoo14.github.io/LoadingAnimation.js';
      
      // ====== RESTAURANT SETTINGS ====== //
      // REPLACE THESE VALUES WITH YOUR RESTAURANT'S LOCATION
      const RESTAURANT_LAT = 40.7128;   // Your restaurant's latitude
      const RESTAURANT_LON = -74.0060;   // Your restaurant's longitude
      const MAX_DISTANCE_KM = 0.05;      // 50 meter radius (adjust as needed)
      // ================================ //
      
      // Chat initialization variables
      let chatInitialized = false;
      const synth = window.speechSynthesis;
      const urlParams = new URLSearchParams(window.location.search);
      const tableNumber = urlParams.get('table');
      let countdown = 3;
      let locationVerified = false;

      // Update viewport height for mobile devices
      function updateViewportHeight() {
          document.documentElement.style.setProperty('--vh', window.innerHeight * 0.01 + 'px');
      }

      // Initialize the chat
      function initializeChat() {
          if (chatInitialized) return;
          chatInitialized = true;
          
          // Hide initial loading screen
          document.getElementById('initial-loading').style.display = 'none';
          
          // Show loading spinner
          const loading = document.getElementById('loading');
          loading.style.display = 'flex';
          setTimeout(() => loading.style.opacity = '1', 10);

          // Create Voiceflow script
          const script = document.createElement('script');
          script.src = 'https://cdn.voiceflow.com/widget-next/bundle.mjs';
          
          script.onload = () => {
              window.voiceflow.chat.load({
                  verify: { projectID: '6849cc61894655c0d602c27d' },
                  url: 'https://general-runtime.voiceflow.com',
                  versionID: 'production',
                  assistant: {
                      stylesheet: 'https://chhotoo14.github.io/restaurantbackground.css',
                      extensions: [LoadingAnimationExtension]
                  },
                  // Pass table number to Voiceflow
                  launch: {
                      event: {
                          type: 'launch',
                          payload: {
                              tableNumber: parseInt(tableNumber) || 0
                          }
                      }
                  },
                  render: {
                      mode: 'embedded',
                      target: document.getElementById('voiceflow-container'),
                      launcher: 'none'
                  }
              }).then(() => {
                  // Show the chat container
                  document.getElementById('voiceflow-container').classList.add('active');
                  
                  // Auto-focus input
                  setTimeout(() => {
                      document.querySelector('input[type="text"]')?.focus();
                  }, 500);

                  // Handle bot messages with text-to-speech
                  const observer = new MutationObserver(mutations => {
                      mutations.forEach(({ addedNodes }) => {
                          addedNodes.forEach(node => {
                              if (node.classList?.contains('vfrc-message--bot')) {
                                  const text = node.querySelector('.vfrc-message-content')?.textContent;
                                  if (text) {
                                      const utterance = new SpeechSynthesisUtterance(text);
                                      utterance.rate = 1.1;
                                      synth.speak(utterance);
                                  }
                              }
                          });
                      });
                  });

                  observer.observe(document.body, {
                      childList: true,
                      subtree: true
                  });

                  // Hide loading spinner
                  loading.style.opacity = '0';
                  setTimeout(() => loading.style.display = 'none', 300);
              });
          };

          script.onerror = () => {
              const loading = document.getElementById('loading');
              loading.innerHTML = 'Failed to load chat. Please check connection.';
          };

          document.body.appendChild(script);
      }

      // Calculate distance between two coordinates (Haversine formula)
      function calculateDistance(lat1, lon1, lat2, lon2) {
          const R = 6371; // Earth radius in km
          const dLat = deg2rad(lat2 - lat1);
          const dLon = deg2rad(lon2 - lon1);
          const a = 
              Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
              Math.sin(dLon/2) * Math.sin(dLon/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
          const distance = R * c; // Distance in km
          return distance;
      }

      function deg2rad(deg) {
          return deg * (Math.PI/180);
      }

      // Verify user's location
      function verifyLocation() {
          const locationMessage = document.getElementById('location-message');
          
          // First try with IP-based location (less accurate but doesn't require permission)
          fetch('https://ipapi.co/json/')
            .then(response => response.json())
            .then(ipData => {
                const ipDistance = calculateDistance(
                    RESTAURANT_LAT, 
                    RESTAURANT_LON, 
                    ipData.latitude, 
                    ipData.longitude
                );
                
                // If IP-based location is within range, proceed
                if (ipDistance <= MAX_DISTANCE_KM) {
                    locationMessage.innerHTML = '<div class="location-icon">‚úÖ</div>Location verified!';
                    locationVerified = true;
                    startCountdown();
                    return;
                }
                
                // If IP location fails, request precise GPS
                if (navigator.geolocation) {
                    locationMessage.innerHTML = '<div class="location-icon">üìç</div>Precise location required...';
                    
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const userLat = position.coords.latitude;
                            const userLon = position.coords.longitude;
                            const distance = calculateDistance(
                                RESTAURANT_LAT, 
                                RESTAURANT_LON, 
                                userLat, 
                                userLon
                            );
                            
                            if (distance <= MAX_DISTANCE_KM) {
                                locationMessage.innerHTML = '<div class="location-icon">‚úÖ</div>Location verified!';
                                locationVerified = true;
                                startCountdown();
                            } else {
                                locationMessage.innerHTML = `
                                    <div class="location-icon">‚ö†Ô∏è</div>
                                    Please visit our restaurant to access this service
                                    <p style="font-size:0.8rem; margin-top:10px;">
                                        You're ${distance.toFixed(2)} km away
                                    </p>
                                    <button class="retry-button" onclick="verifyLocation()">Retry</button>
                                `;
                            }
                        },
                        error => {
                            locationMessage.innerHTML = `
                                <div class="location-icon">‚ùå</div>
                                Location access required for ordering
                                <button class="retry-button" onclick="verifyLocation()">Try Again</button>
                            `;
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                } else {
                    locationMessage.innerHTML = `
                        <div class="location-icon">‚ö†Ô∏è</div>
                        Your browser doesn't support location services
                    `;
                }
            })
            .catch(() => {
                // If IP API fails, fallback to GPS directly
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const userLat = position.coords.latitude;
                            const userLon = position.coords.longitude;
                            const distance = calculateDistance(
                                RESTAURANT_LAT, 
                                RESTAURANT_LON, 
                                userLat, 
                                userLon
                            );
                            
                            if (distance <= MAX_DISTANCE_KM) {
                                locationMessage.innerHTML = '<div class="location-icon">‚úÖ</div>Location verified!';
                                locationVerified = true;
                                startCountdown();
                            } else {
                                locationMessage.innerHTML = `
                                    <div class="location-icon">‚ö†Ô∏è</div>
                                    Please visit our restaurant to access this service
                                    <p style="font-size:0.8rem; margin-top:10px;">
                                        You're ${distance.toFixed(2)} km away
                                    </p>
                                    <button class="retry-button" onclick="verifyLocation()">Retry</button>
                                `;
                            }
                        },
                        error => {
                            locationMessage.innerHTML = `
                                <div class="location-icon">‚ùå</div>
                                Location access required for ordering
                                <button class="retry-button" onclick="verifyLocation()">Try Again</button>
                            `;
                        }
                    );
                } else {
                    locationMessage.innerHTML = `
                        <div class="location-icon">‚ö†Ô∏è</div>
                        Your browser doesn't support location services
                    `;
                }
            });
      }

      // Start countdown and progress animation
      function startCountdown() {
          const progressBar = document.getElementById('progress-bar');
          const countdownElement = document.getElementById('countdown');
          
          let progress = 0;
          const interval = setInterval(() => {
              progress += 100 / (countdown * 10);
              progressBar.style.width = `${progress}%`;
              
              if (progress >= 100) {
                  clearInterval(interval);
                  initializeChat();
              }
          }, 100);
          
          // Update countdown text
          const countdownInterval = setInterval(() => {
              countdown--;
              if (countdown <= 0) {
                  countdownElement.textContent = "Starting now...";
                  clearInterval(countdownInterval);
              } else {
                  countdownElement.textContent = `Starting in ${countdown} second${countdown !== 1 ? 's' : ''}...`;
              }
          }, 1000);
      }

      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
          updateViewportHeight();
          window.addEventListener('resize', updateViewportHeight);
          
          // Validate table number
          const initialLoading = document.getElementById('initial-loading');
          
          if (!tableNumber || isNaN(tableNumber)) {
              initialLoading.innerHTML = `
                  <div class="logo-container">
                      <div class="logo">CRUNCH<span>CRAFT</span></div>
                  </div>
                  <div style="text-align: center; color: white; max-width: 80%;">
                      <h2 style="margin-bottom: 20px;">‚ö†Ô∏è Invalid QR Code</h2>
                      <p>Please scan the QR code on your table to start ordering.</p>
                      <p style="margin-top: 30px; font-size: 0.9rem;">If you believe this is an error, please ask a staff member for assistance.</p>
                  </div>
              `;
          } else {
              // Start location verification
              setTimeout(verifyLocation, 500);
          }
      });
      
      // Make verifyLocation accessible globally for retry button
      window.verifyLocation = verifyLocation;
    </script>
</body>
</html>
